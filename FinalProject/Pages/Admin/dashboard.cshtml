@page
@model FinalProject.Pages.Admin.DashboardModel
@using System.Text.Json
@{
    ViewData["Title"] = "แดชบอร์ดผู้ดูแลระบบ";
    var vm = Model.VM;
    int Pages(int total, int size) => Math.Max(1, (int)Math.Ceiling(total / (double)size));
}

@section Styles {
    <link rel="stylesheet" href="~/css/admin-dashboard.css" asp-append-version="true" />
}

<div class="container-fluid my-4 admin-dashboard">
    <div class="d-flex align-items-center justify-content-between mb-3">
        <h1 class="page-title">แดชบอร์ดผู้ดูแลระบบ</h1>
        <div class="d-flex gap-2">
            <span class="badge-brand">ออนไลน์</span>
        </div>
    </div>

    <!-- KPI -->
    <div class="row g-3 mb-4">
        <div class="col-6 col-md-3">
            <div class="kpi-card">
                <div class="kpi-title">จำนวนเบียร์</div>
                <div class="kpi-value">@vm.TotalBeers</div>
                <div class="kpi-sub">ทั้งหมดในระบบ</div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="kpi-card">
                <div class="kpi-title">ผู้ใช้งาน</div>
                <div class="kpi-value">@vm.TotalUsers</div>
                <div class="kpi-sub">บัญชีที่ลงทะเบียน</div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="kpi-card">
                <div class="kpi-title">การให้คะแนน</div>
                <div class="kpi-value small">@vm.RatingsCount</div>
                <div class="kpi-sub">เฉลี่ย @vm.RatingsAvg.ToString("0.00") / 5</div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="kpi-card">
                <div class="kpi-title">ถูกใจ</div>
                <div class="kpi-value">@vm.TotalFavorites</div>
                <div class="kpi-sub">ยอดกดถูกใจทั้งหมด</div>
            </div>
        </div>

        <div class="col-6 col-md-4">
            <div class="kpi-card">
                <div class="kpi-title">ความคิดเห็น</div>
                <div class="kpi-value small">@vm.TotalComments</div>
                <div class="kpi-sub">ทั้งหมด</div>
            </div>
        </div>
        <div class="col-6 col-md-4">
            <div class="kpi-card">
                <div class="kpi-title">รีวิวผู้ใช้</div>
                <div class="kpi-value small">@vm.TotalReviews</div>
                <div class="kpi-sub">ทั้งหมด</div>
            </div>
        </div>
        <div class="col-12 col-md-4">
            <div class="kpi-card">
                <div class="kpi-title">จำนวนการเข้าชมเบียร์</div>
                <div class="kpi-value small">@vm.BeerViewcount</div>
                <div class="kpi-sub">รวมทั้งหมด</div>
            </div>
        </div>
    </div>

    <!-- CHARTS -->
    <div class="row g-3 mb-4">
        <div class="col-12 col-lg-7">
            <div class="card-lite">
                <div class="card-header px-3 py-2">
                    <h5 class="mb-0">สถิติการให้คะแนน (30 วันล่าสุด)</h5>
                </div>
                <div class="p-3">
                    @if (vm.RatingsOverTime?.Count > 0)
                    {
                        <canvas id="ratingsLine"></canvas>
                    }
                    else
                    {
                        <div class="text-muted">ยังไม่มีข้อมูลเพียงพอ</div>
                    }
                </div>
            </div>
        </div>
        <div class="col-12 col-lg-5">
            <div class="card-lite">
                <div class="card-header px-3 py-2">
                    <h5 class="mb-0">จำนวนเบียร์ตามจังหวัด</h5>
                </div>
                <div class="p-3">
                    @if (vm.BeersByProvince?.Count > 0)
                    {
                        <canvas id="provinceBar"></canvas>
                    }
                    else
                    {
                        <div class="text-muted">ยังไม่มีข้อมูลการกระจาย</div>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- TABLES -->
    <div id="lists"></div>
    <div class="row g-3">

        <!-- Top Rated -->
        <div class="col-12 col-xl-6">
            <div class="card-table">
                <div class="card-header px-3 py-2"><h5 class="mb-0">เบียร์ที่ได้คะแนนสูงสุด</h5></div>
                <div class="table-responsive">
                    <table class="table table-modern mb-0">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>ชื่อ</th>
                                <th>จังหวัด</th>
                                <th class="text-end">คะแนนเฉลี่ย</th>
                                <th class="text-end">จำนวนโหวต</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (vm.TopRatedBeers?.Count > 0)
                            {
                                var i = 1 + ((Model.TopRatedPage.Page - 1) * Model.TopRatedPage.PageSize);
                                foreach (var b in vm.TopRatedBeers)
                                {
                                    <tr>
                                        <td>@i</td>
                                        <td class="truncate">@b.Name</td>
                                        <td>@b.Province</td>
                                        <td class="text-end">@b.Avg.ToString("0.00")</td>
                                        <td class="text-end">@b.Count</td>
                                    </tr>
                                    i++;
                                }
                            }
                            else
                            {
                                <tr><td colspan="5" class="text-muted">ไม่มีข้อมูล</td></tr>
                            }
                        </tbody>
                    </table>
                </div>
                <div class="pager">
                    <div class="info">หน้า @Model.TopRatedPage.Page จาก @Pages(Model.TopRatedPage.Total, Model.TopRatedPage.PageSize)</div>
                    <a class="@(Model.TopRatedPage.HasPrev ? "" : "disabled")" href="@(Model.TopRatedPage.PrevUrl ?? "#")">‹ ก่อนหน้า</a>
                    <a class="@(Model.TopRatedPage.HasNext ? "" : "disabled")" href="@(Model.TopRatedPage.NextUrl ?? "#")">ถัดไป ›</a>
                </div>
            </div>
        </div>

        <!-- Most Favorited -->
        <div class="col-12 col-xl-6">
            <div class="card-table">
                <div class="card-header px-3 py-2"><h5 class="mb-0">เบียร์ที่ถูกใจกันมากที่สุด</h5></div>
                <div class="table-responsive">
                    <table class="table table-modern mb-0">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>ชื่อ</th>
                                <th>จังหวัด</th>
                                <th class="text-end">ถูกใจ</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (vm.MostFavoritedBeers?.Count > 0)
                            {
                                var i = 1 + ((Model.MostFavPage.Page - 1) * Model.MostFavPage.PageSize);
                                foreach (var b in vm.MostFavoritedBeers)
                                {
                                    <tr>
                                        <td>@i</td>
                                        <td class="truncate">@b.Name</td>
                                        <td>@b.Province</td>
                                        <td class="text-end">@b.Favorites</td>
                                    </tr>
                                    i++;
                                }
                            }
                            else
                            {
                                <tr><td colspan="4" class="text-muted">ไม่มีข้อมูล</td></tr>
                            }
                        </tbody>
                    </table>
                </div>
                <div class="pager">
                    <div class="info">หน้า @Model.MostFavPage.Page จาก @Pages(Model.MostFavPage.Total, Model.MostFavPage.PageSize)</div>
                    <a class="@(Model.MostFavPage.HasPrev ? "" : "disabled")" href="@(Model.MostFavPage.PrevUrl ?? "#")">‹ ก่อนหน้า</a>
                    <a class="@(Model.MostFavPage.HasNext ? "" : "disabled")" href="@(Model.MostFavPage.NextUrl ?? "#")">ถัดไป ›</a>
                </div>
            </div>
        </div>

        <!-- Most Viewed -->
        <div class="col-12">
            <div class="card-table">
                <div class="card-header px-3 py-2 d-flex justify-content-between">
                    <h5 class="mb-0">เบียร์ที่มีคนเข้าชมมากที่สุด</h5>
                    <div class="text-muted">รวมทั้งหมด: <strong>@vm.BeerViewcount</strong> ครั้ง</div>
                </div>
                <div class="table-responsive">
                    <table class="table table-modern mb-0">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>ชื่อ</th>
                                <th>จังหวัด</th>
                                <th class="text-end">คะแนนเฉลี่ย</th>
                                <th class="text-end">โหวต</th>
                                <th class="text-end">เข้าชม</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (vm.MostViewedBeers?.Count > 0)
                            {
                                var i = 1 + ((Model.MostViewPage.Page - 1) * Model.MostViewPage.PageSize);
                                foreach (var b in vm.MostViewedBeers)
                                {
                                    <tr>
                                        <td>@i</td>
                                        <td class="truncate">@b.Name</td>
                                        <td>@b.Province</td>
                                        <td class="text-end">@b.Avg.ToString("0.00")</td>
                                        <td class="text-end">@b.Count</td>
                                        <td class="text-end"><span class="chip"><span class="dot"></span>@b.ViewCount</span></td>
                                    </tr>
                                    i++;
                                }
                            }
                            else
                            {
                                <tr><td colspan="6" class="text-muted">ไม่มีข้อมูล</td></tr>
                            }
                        </tbody>
                    </table>
                </div>
                <div class="pager">
                    <div class="info">หน้า @Model.MostViewPage.Page จาก @Pages(Model.MostViewPage.Total, Model.MostViewPage.PageSize)</div>
                    <a class="@(Model.MostViewPage.HasPrev ? "" : "disabled")" href="@(Model.MostViewPage.PrevUrl ?? "#")">‹ ก่อนหน้า</a>
                    <a class="@(Model.MostViewPage.HasNext ? "" : "disabled")" href="@(Model.MostViewPage.NextUrl ?? "#")">ถัดไป ›</a>
                </div>
            </div>
        </div>

        <!-- Recent Comments -->
        <div class="col-12">
            <div class="card-table">
                <div class="card-header px-3 py-2"><h5 class="mb-0">ความคิดเห็นล่าสุด</h5></div>
                <div class="table-responsive">
                    <table class="table table-modern mb-0">
                        <thead>
                            <tr>
                                <th>เวลา</th>
                                <th>ชื่อเบียร์</th>
                                <th>ผู้ใช้</th>
                                <th>ข้อความ</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (vm.RecentComments?.Count > 0)
                            {
                                foreach (var c in vm.RecentComments)
                                {
                                    <tr>
                                        <td>@c.CreatedAt.ToString("yyyy-MM-dd HH:mm")</td>
                                        <td class="truncate">@c.BeerName</td>
                                        <td>@c.UserName</td>
                                        <td class="truncate">@c.Body</td>
                                    </tr>
                                }
                            }
                            else
                            {
                                <tr><td colspan="4" class="text-muted">ยังไม่มีความคิดเห็น</td></tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- DATA -->
<script id="ratings-data" type="application/json">
    @Html.Raw(JsonSerializer.Serialize(vm.RatingsOverTime ?? new List<FinalProject.ViewModels.DailyRatingPoint>()))
</script>
<script id="provinces-data" type="application/json">
    @Html.Raw(JsonSerializer.Serialize(vm.BeersByProvince ?? new List<FinalProject.ViewModels.ProvinceCount>()))
</script>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="~/js/admin-dashboard.js" asp-append-version="true"></script>
}
