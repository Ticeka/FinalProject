@page
@model FinalProject.Pages.Admin.DashboardModel
@using System.Text.Json
@{
    ViewData["Title"] = "Dashboard";

    // ✅ ให้ JSON เป็น camelCase เพื่อให้ตรงกับ JS
    var jsonOpts = new JsonSerializerOptions { PropertyNamingPolicy = JsonNamingPolicy.CamelCase };
    var ratingsJson = JsonSerializer.Serialize(Model.VM.RatingsOverTime, jsonOpts);
    var provincesJson = JsonSerializer.Serialize(Model.VM.BeersByProvince, jsonOpts);
}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" />
<link rel="stylesheet" href="~/css/admin-dashboard.css" asp-append-version="true" />

<div class="container-fluid my-4 admin-dashboard">
    <div class="d-flex align-items-center justify-content-between mb-3">
        <h1 class="page-title">Admin Dashboard</h1>
    </div>

    <!-- KPI Cards -->
    <div class="row g-3">
        <div class="col-6 col-md-3">
            <div class="kpi-card">
                <div class="kpi-title">Drinks</div>
                <div class="kpi-value">@Model.VM.TotalBeers</div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="kpi-card">
                <div class="kpi-title">Users</div>
                <div class="kpi-value">@Model.VM.TotalUsers</div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="kpi-card">
                <div class="kpi-title">Comments</div>
                <div class="kpi-value">@Model.VM.TotalComments</div>
                <div class="kpi-sub">User stats: @Model.VM.TotalUserComments</div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="kpi-card">
                <div class="kpi-title">Favorites</div>
                <div class="kpi-value">@Model.VM.TotalFavorites</div>
            </div>
        </div>
    </div>

    <div class="row g-3 mt-1">
        <div class="col-6 col-md-3">
            <div class="kpi-card">
                <div class="kpi-title">Reviews (sum)</div>
                <div class="kpi-value small">@Model.VM.TotalReviews</div>
                <div class="kpi-sub">Badges: @Model.VM.TotalUserBadges</div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="kpi-card">
                <div class="kpi-title">Quick Ratings</div>
                <div class="kpi-value small">@Model.VM.RatingsCount</div>
                <div class="kpi-sub">Avg: @Model.VM.RatingsAvg.ToString("0.00")</div>
            </div>
        </div>
    </div>

    <!-- Charts -->
    <div class="row g-3 mt-2">
        <div class="col-12 col-lg-7">
            <div class="card card-lite h-100">
                <div class="card-header fw-semibold">Ratings (last 30 days)</div>
                <div class="card-body">
                    <canvas id="ratingsLine" role="img" aria-label="Ratings in last 30 days"></canvas>
                </div>
            </div>
        </div>
        <div class="col-12 col-lg-5">
            <div class="card card-lite h-100">
                <div class="card-header fw-semibold">Beers by Province</div>
                <div class="card-body">
                    <canvas id="provinceBar" role="img" aria-label="Beers count by province"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Tables -->
    <div class="row g-3 mt-2">
        <div class="col-12 col-lg-6">
            <div class="card card-table h-100">
                <div class="card-header fw-semibold">Top Rated Beers</div>
                <div class="table-responsive">
                    <table class="table align-middle mb-0 table-hover table-modern">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Province</th>
                                <th class="text-end">Avg</th>
                                <th class="text-end">Ratings</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var b in Model.VM.TopRatedBeers)
                            {
                                <tr>
                                    <td>@b.Name</td>
                                    <td>@b.Province</td>
                                    <td class="text-end">@b.Avg.ToString("0.00")</td>
                                    <td class="text-end">@b.Count</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="col-12 col-lg-6">
            <div class="card card-table h-100">
                <div class="card-header fw-semibold">Most Favorited Beers</div>
                <div class="table-responsive">
                    <table class="table align-middle mb-0 table-hover table-modern">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Province</th>
                                <th class="text-end">Favorites</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var b in Model.VM.MostFavoritedBeers)
                            {
                                <tr>
                                    <td>@b.Name</td>
                                    <td>@b.Province</td>
                                    <td class="text-end">@b.Favorites</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ส่งข้อมูลให้ไฟล์ JS ผ่าน JSON script tag -->
<script type="application/json" id="ratings-data">@Html.Raw(ratingsJson)</script>
<script type="application/json" id="provinces-data">@Html.Raw(provincesJson)</script>

<!-- โหลด Chart.js ก่อน แล้วค่อยไฟล์ของเรา -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="~/js/admin-dashboard.js" asp-append-version="true"></script>
