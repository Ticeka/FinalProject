@page
@model FinalProject.Pages.DetailModel
@{
    ViewData["Title"] = "รายละเอียดเครื่องดื่ม";
    var b = Model.LocalBeer;

    // รูปภาพ: รองรับทั้ง http(s), path เริ่มด้วย '/', หรือชื่อไฟล์
    string imageSrc;
    if (!string.IsNullOrWhiteSpace(b?.ImageUrl))
    {
        imageSrc = (b.ImageUrl.StartsWith("http", StringComparison.OrdinalIgnoreCase) || b.ImageUrl.StartsWith("/"))
            ? b.ImageUrl
            : $"/images/beers/{b.ImageUrl}";
    }
    else
    {
        imageSrc = "https://via.placeholder.com/640x853?text=Image";
    }

    // Safe values
    var priceSafe = b?.Price ?? 0m;
    var abvSafe = b?.AlcoholLevel ?? 0d;
    var ratingSafe = b?.Rating ?? 0d;
    var countSafe = b?.RatingCount ?? 0;

    string ChipIconByType(string? t)
        => (t ?? "").ToLower().Contains("ไวน์") || (t ?? "").ToLower().Contains("wine") ? "🍷"
         : (t ?? "").ToLower().Contains("เบียร์") || (t ?? "").ToLower().Contains("beer") || (t ?? "").ToLower().Contains("ลาเกอร์") || (t ?? "").ToLower().Contains("ipa") ? "🍺"
         : (t ?? "").ToLower().Contains("วิสกี้") || (t ?? "").ToLower().Contains("เหล้า") || (t ?? "").ToLower().Contains("rum") || (t ?? "").ToLower().Contains("whisky") || (t ?? "").ToLower().Contains("liquor") ? "🥃"
         : "🍶";
}
@functions {
    string IconByFlavor(string? f)
    {
        var s = (f ?? string.Empty).ToLowerInvariant();
        if (s.Contains("citrus") || s.Contains("ส้ม") || s.Contains("เลมอน") || s.Contains("lime")) return "🍊";
        if (s.Contains("herb") || s.Contains("สมุนไพร") || s.Contains("ใบไม้")) return "🌿";
        if (s.Contains("sweet") || s.Contains("หวาน") || s.Contains("คาราเมล") || s.Contains("vanilla")) return "🍯";
        if (s.Contains("bitter") || s.Contains("ขม") || s.Contains("hop") || s.Contains("ฮ็อป")) return "🌱";
        if (s.Contains("roast") || s.Contains("คั่ว") || s.Contains("ช็อกโกแลต") || s.Contains("coffee")) return "🍫";
        if (s.Contains("spice") || s.Contains("เผ็ดร้อน")) return "🌶️";
        return "🟡";
    }
}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<link rel="stylesheet" href="~/css/detail.css" />

<style>
    /* ===== Floating Edit Button (Admin only) ===== */
    .fab-edit {
        position: fixed;
        right: 18px;
        bottom: 18px;
        z-index: 1050;
        border-radius: 999px;
        box-shadow: 0 12px 28px rgba(0,0,0,.18);
        display: grid;
        place-items: center;
        gap: .35rem;
        padding: .9rem 1rem;
        font-weight: 700;
    }

        .fab-edit .label {
            display: none;
        }

        .fab-edit:hover {
            transform: translateY(-2px);
        }

        .fab-edit:active {
            transform: translateY(0);
        }

    @@media (min-width: 992px) {
        .fab-edit .label {
            display: inline;
            margin-left: .35rem;
        }
    }

    .fab-edit.dragging {
        cursor: grabbing;
        user-select: none;
    }
</style>

@if (b is null)
{
    <div class="container py-5">
        <div class="alert alert-warning">ไม่พบข้อมูลรายการนี้</div>
        <a asp-page="/List" class="btn btn-outline-secondary mt-2">⬅️ กลับไปรายการทั้งหมด</a>
    </div>
}
else
{
    <!-- data สำหรับ JS -->
    <div id="beerData"
         data-id="@b.Id"
         data-name="@b.Name"
         data-type="@b.Type"
         data-province="@b.Province"
         data-description="@b.Description"
         data-lat="@b.Latitude.ToString(System.Globalization.CultureInfo.InvariantCulture)"
         data-lng="@b.Longitude.ToString(System.Globalization.CultureInfo.InvariantCulture)"
         data-price="@priceSafe.ToString(System.Globalization.CultureInfo.InvariantCulture)"
         data-abv="@abvSafe.ToString(System.Globalization.CultureInfo.InvariantCulture)"
         data-rating="@ratingSafe.ToString(System.Globalization.CultureInfo.InvariantCulture)"
         data-count="@countSafe"
         data-website="@b.Website"
         data-facebook="@b.FacebookPage"
         data-phone="@b.PhoneNumber"
         data-auth="@(User?.Identity?.IsAuthenticated == true)">
    </div>

    <div class="container py-4" itemscope itemtype="https://schema.org/Product">
        <!-- Breadcrumb -->
        <nav aria-label="breadcrumb" class="mb-3">
            <ol class="breadcrumb mb-0">
                <li class="breadcrumb-item"><a class="backlink" asp-page="/Index">แผนที่</a></li>
                <li class="breadcrumb-item"><a class="backlink" asp-page="/List">รายการ</a></li>
                <li class="breadcrumb-item active" aria-current="page">รายละเอียด</li>
            </ol>
        </nav>

        <!-- Hero -->
        <header class="page-hero rounded-4 p-3 p-md-4 p-lg-5 mb-4">
            <div class="row g-4 align-items-lg-center">
                <div class="col-lg-5">
                    <div class="hero-wrap">
                        <img itemprop="image" src="@imageSrc" alt="@b.Name" class="thumb-lg w-100"
                             onerror="this.src='https://via.placeholder.com/640x853?text=Image'" />
                        <!-- ปุ่มถูกใจลอยบนรูป -->
                        <button id="favBtn" class="fav-fab" type="button" aria-pressed="false" aria-label="ถูกใจรายการนี้" title="เพิ่มในรายการถูกใจ">❤</button>
                    </div>
                </div>

                <div class="col-lg-7">
                    <div class="d-flex flex-wrap align-items-center justify-content-between gap-2">
                        <h1 class="h3 h-md-2 mb-0" itemprop="name">@b.Name</h1>

                        <!-- ปุ่มถูกใจแบบอินไลน์ (สำรองสำหรับจอเล็ก) -->
                        <button class="btn btn-outline-danger fav-inline d-lg-none" type="button" title="เพิ่มในรายการถูกใจ" onclick="document.getElementById('favBtn').click()">
                            ❤ ถูกใจ
                        </button>
                    </div>

                    <div class="d-flex flex-wrap gap-2 mt-3">
                        @if (!string.IsNullOrWhiteSpace(b.Province))
                        {
                            <span class="chip" title="จังหวัด">📍 @b.Province</span>
                        }
                        @if (!string.IsNullOrWhiteSpace(b.Type))
                        {
                            <span class="chip" title="ประเภทเครื่องดื่ม">@ChipIconByType(b.Type) @b.Type</span>
                        }
                        @if (abvSafe > 0d)
                        {
                            <span class="chip" title="ปริมาณแอลกอฮอล์">🔥 @abvSafe% ABV</span>
                        }
                        @if (priceSafe > 0m)
                        {
                            <span class="chip" title="ราคา">💰 <span id="priceVal">@priceSafe</span> บาท</span>
                        }
                    </div>

                    <!-- ให้ดาวแบบไม่ล็อกอิน -->
                    <div class="ratebox mt-3" data-id="@b.Id"
                         data-avg="@ratingSafe.ToString("0.0")"
                         data-count="@countSafe">
                        <div class="stars" role="radiogroup" aria-label="ให้คะแนน">
                            <button type="button" data-score="1" aria-label="1 ดาว">★</button>
                            <button type="button" data-score="2" aria-label="2 ดาว">★</button>
                            <button type="button" data-score="3" aria-label="3 ดาว">★</button>
                            <button type="button" data-score="4" aria-label="4 ดาว">★</button>
                            <button type="button" data-score="5" aria-label="5 ดาว">★</button>
                        </div>
                        <div class="small text-muted">
                            เฉลี่ย <span class="avg">@ratingSafe.ToString("0.0")</span> จาก <span class="cnt">@countSafe</span> รีวิว
                        </div>
                    </div>

                    @if (!string.IsNullOrWhiteSpace(b.Description))
                    {
                        <p class="text-secondary mt-3 mb-0" itemprop="description">@b.Description</p>
                    }

                    @if (ratingSafe > 0d)
                    {
                        var stars = Math.Round(ratingSafe);
                        <div class="rating-stars mt-3" aria-label="คะแนนเฉลี่ย @ratingSafe จาก @countSafe รีวิว">
                            @Html.Raw(new string('★', (int)stars))@Html.Raw(new string('☆', 5 - (int)stars))
                            <span class="text-muted">(@ratingSafe.ToString("0.0"))</span>
                        </div>
                    }
                    @if (countSafe > 0)
                    {
                        <div class="text-muted mt-1">รีวิวทั้งหมด: <strong>@countSafe</strong></div>
                    }

                    <!-- Quick actions -->
                    <div class="d-flex flex-wrap gap-2 mt-4">
                        <a asp-page="/List" class="btn btn-soft">⬅️ กลับไปรายการ</a>
                        <a asp-page="/Index" class="btn btn-primary">ดูบนแผนที่รวม</a>
                        @if (!string.IsNullOrWhiteSpace(b.Website))
                        {
                            <a href="@b.Website" target="_blank" rel="noopener" class="btn btn-soft" title="ไปยังเว็บไซต์">เว็บไซต์</a>
                        }
                        @if (!string.IsNullOrWhiteSpace(b.FacebookPage))
                        {
                            <a href="@b.FacebookPage" target="_blank" rel="noopener" class="btn btn-soft" title="ไปยัง Facebook">Facebook</a>
                        }
                        @if (!string.IsNullOrWhiteSpace(b.PhoneNumber))
                        {
                            <a href="tel:@b.PhoneNumber" class="btn btn-soft" title="โทร">@b.PhoneNumber</a>
                        }
                        <button id="copyLinkBtn" class="btn btn-outline-secondary" title="คัดลอกลิงก์">🔗 คัดลอกลิงก์</button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Key Facts -->
        <section class="section p-4 p-md-5 mb-4">
            <div class="d-flex align-items-center justify-content-between mb-2">
                <h2 class="h5 mb-0">ข้อมูลสำคัญ</h2>
            </div>
            <div class="meta-grid" style="--gap:1rem;display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:var(--gap)">
                @if (!string.IsNullOrWhiteSpace(b.PlaceOfOrigin))
                {
                    <div><div class="text-muted small">แหล่งกำเนิด</div><div>@b.PlaceOfOrigin</div></div>
                }
                @if (!string.IsNullOrWhiteSpace(b.Region))
                {
                    <div><div class="text-muted small">ภูมิภาค</div><div>@b.Region</div></div>
                }
                @if (b.ProductYear != null)
                {
                    <div><div class="text-muted small">ปีผลิต</div><div>@b.ProductYear</div></div>
                }
                @if (!string.IsNullOrWhiteSpace(b.Creator))
                {
                    <div><div class="text-muted small">ผู้ผลิต/ผู้สร้างสรรค์</div><div>@b.Creator</div></div>
                }
                @if (!string.IsNullOrWhiteSpace(b.MainIngredients))
                {
                    <div><div class="text-muted small">วัตถุดิบหลัก</div><div>@b.MainIngredients</div></div>
                }
                @if (!string.IsNullOrWhiteSpace(b.ProductMethod))
                {
                    <div><div class="text-muted small">วิธีการผลิต</div><div>@b.ProductMethod</div></div>
                }
                @if (b.Volume != null)
                {
                    <div><div class="text-muted small">ปริมาตร</div><div>@b.Volume ml</div></div>
                }
                @if (!string.IsNullOrWhiteSpace(b.Distributor))
                {
                    <div><div class="text-muted small">ผู้จัดจำหน่าย</div><div>@b.Distributor</div></div>
                }
                @if (!string.IsNullOrWhiteSpace(b.DistributorChanel))
                {
                    <div><div class="text-muted small">ช่องทางจัดจำหน่าย</div><div>@b.DistributorChanel</div></div>
                }
                @if (!string.IsNullOrWhiteSpace(b.Award))
                {
                    <div><div class="text-muted small">รางวัล</div><div>@b.Award</div></div>
                }
                @if (!string.IsNullOrWhiteSpace(b.Rights))
                {
                    <div><div class="text-muted small">ลิขสิทธิ์/สิทธิ์</div><div>@b.Rights</div></div>
                }
                @if (!string.IsNullOrWhiteSpace(b.Notes))
                {
                    <div><div class="text-muted small">บันทึก</div><div>@b.Notes</div></div>
                }
            </div>
        </section>

        <!-- Spec Table -->
        <section class="section p-4 p-md-5 mb-4">
            <h2 class="h5 mb-3">สเปก & รหัสอ้างอิง</h2>
            <div class="table-responsive">
                <table class="table align-middle spec-table mb-0">
                    <tbody>
                        @if (!string.IsNullOrWhiteSpace(b.ProductId))
                        {
                            <tr><th>Product ID</th><td>@b.ProductId</td></tr>
                        }
                        @if (!string.IsNullOrWhiteSpace(b.TypeOfLiquor))
                        {
                            <tr><th>Type of Liquor</th><td>@b.TypeOfLiquor</td></tr>
                        }
                        @if (!string.IsNullOrWhiteSpace(b.PlaceOfOrigin))
                        {
                            <tr><th>Place of Origin</th><td>@b.PlaceOfOrigin</td></tr>
                        }
                        @if (!string.IsNullOrWhiteSpace(b.Region))
                        {
                            <tr><th>Region</th><td>@b.Region</td></tr>
                        }
                        @if (abvSafe > 0d)
                        {
                            <tr><th>ABV</th><td>@abvSafe%</td></tr>
                        }
                        @if (b.Volume != null)
                        {
                            <tr><th>Volume</th><td>@b.Volume ml</td></tr>
                        }
                        @if (!string.IsNullOrWhiteSpace(b.MainIngredients))
                        {
                            <tr><th>Main ingredients</th><td>@b.MainIngredients</td></tr>
                        }
                        @if (!string.IsNullOrWhiteSpace(b.ProductMethod))
                        {
                            <tr><th>Product Method</th><td>@b.ProductMethod</td></tr>
                        }
                        @if (!string.IsNullOrWhiteSpace(b.Description))
                        {
                            <tr><th>Description</th><td>@b.Description</td></tr>
                        }
                        @if (priceSafe > 0m)
                        {
                            <tr><th>Price</th><td><span id="priceVal2">@priceSafe</span> บาท</td></tr>
                        }
                        @if (b.ProductYear != null)
                        {
                            <tr><th>Product Year</th><td>@b.ProductYear</td></tr>
                        }
                        @if (!string.IsNullOrWhiteSpace(b.Rights))
                        {
                            <tr><th>Rights</th><td>@b.Rights</td></tr>
                        }
                        @if (!string.IsNullOrWhiteSpace(b.Distributor))
                        {
                            <tr><th>Distributor</th><td>@b.Distributor</td></tr>
                        }
                        @if (!string.IsNullOrWhiteSpace(b.DistributorChanel))
                        {
                            <tr><th>Distributor Channel</th><td>@b.DistributorChanel</td></tr>
                        }
                        @if (!string.IsNullOrWhiteSpace(b.Award))
                        {
                            <tr><th>Award</th><td>@b.Award</td></tr>
                        }
                        @if (!string.IsNullOrWhiteSpace(b.Notes))
                        {
                            <tr><th>Notes</th><td>@b.Notes</td></tr>
                        }
                        @if (ratingSafe > 0d)
                        {
                            <tr><th>Average Rating</th><td>@ratingSafe</td></tr>
                        }
                        @if (countSafe > 0)
                        {
                            <tr><th>Rating Count</th><td>@countSafe</td></tr>
                        }
                        @if (b.Latitude != 0 && b.Longitude != 0)
                        {
                            <tr><th>Coordinates</th><td>@b.Latitude, @b.Longitude</td></tr>
                        }
                    </tbody>
                </table>
            </div>
        </section>

        <!-- ลักษณะรสชาติ & เมนูที่เข้ากัน -->
        <section class="section p-4 p-md-5 mb-4">
            <header class="section-head">
                <h2 class="h5 mb-0">ลักษณะรสชาติ & เมนูที่เข้ากัน</h2>
            </header>

            <div class="row g-4">
                <!-- ลักษณะรสชาติ -->
                <div class="col-12 col-lg-6">
                    <h3 class="h6 mb-3">ลักษณะรสชาติ</h3>

                    @if (b?.Flavors != null && b.Flavors.Any())
                    {
                        <ul class="list-group list-group-flush">
                            @foreach (var f in b.Flavors.OrderByDescending(x => x.Intensity))
                            {
                                var raw = f.Intensity; // 0.01..1
                                var pct = Math.Clamp((int)Math.Round(raw * 100), 1, 100);
                                var level = pct >= 70 ? "เด่นชัด" : (pct >= 40 ? "ปานกลาง" : "อ่อน");

                                <li class="list-group-item px-0">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <span class="me-2">@IconByFlavor(f.Flavor)</span>
                                            <strong>@f.Flavor</strong>
                                            <span class="badge rounded-pill bg-light text-secondary ms-2">@level</span>
                                        </div>
                                    </div>
                                    <div class="progress mt-2" style="height:8px;">
                                        <div class="progress-bar" role="progressbar" style="width:@pct%"></div>
                                    </div>
                                </li>
                            }
                        </ul>
                    }
                    else
                    {
                        <div class="text-muted">ยังไม่มีข้อมูลลักษณะรสชาติ</div>
                    }
                </div>

                <!-- เมนูที่เข้ากัน -->
                <div class="col-12 col-lg-6">
                    <h3 class="h6 mb-3">เมนูที่เข้ากัน</h3>

                    @if (b?.FoodPairings != null && b.FoodPairings.Any())
                    {
                        <ul class="list-group list-group-flush">
                            @foreach (var p in b.FoodPairings)
                            {
                                <li class="list-group-item px-0">
                                    <div class="d-flex align-items-start">
                                        <div class="me-2" aria-hidden="true">🍽️</div>
                                        <div>
                                            <strong>@p.FoodName</strong>
                                            @if (!string.IsNullOrWhiteSpace(p.Reason))
                                            {
                                                <div class="text-muted small">@p.Reason</div>
                                            }
                                        </div>
                                    </div>
                                </li>
                            }
                        </ul>
                    }
                    else
                    {
                        <div class="text-muted">ยังไม่มีคำแนะนำเมนูที่เข้ากัน</div>
                    }
                </div>
            </div>
        </section>

        <!-- Map -->
        @if (b.Latitude != 0 && b.Longitude != 0)
        {
            <section class="section p-3 p-md-4 mb-4">
                <div class="d-flex align-items-center justify-content-between px-2 pt-2">
                    <h2 class="h6 mb-0">ตำแหน่งบนแผนที่</h2>
                    <div class="d-flex gap-2">
                        <a asp-page="/Index" class="btn btn-sm btn-outline-primary">ดูบนแผนที่รวม</a>
                        <a id="gmapsBtn" class="btn btn-sm btn-primary" target="_blank" rel="noopener">เปิดใน Google Maps</a>
                    </div>
                </div>
                <div class="p-2 p-md-3">
                    <div id="map"></div>
                </div>
            </section>
        }
    </div>

    <!-- ===== Comments (ล็อกอินเท่านั้นสำหรับการคอมเมนต์/ตอบกลับ) ===== -->
    <section class="section container p-4 p-md-5 mb-5">
        <div class="d-flex align-items-center justify-content-between mb-2">
            <h2 class="h5 mb-0">ความคิดเห็น</h2>
            <button id="cmtReloadBtn" type="button" class="btn btn-outline-secondary btn-sm">โหลดใหม่</button>
        </div>

        @if (User?.Identity?.IsAuthenticated ?? false)
        {
            <form id="cmtForm" class="mb-3" onsubmit="return false">
                <div class="form-floating mb-2">
                    <textarea id="cmtText" class="form-control" style="height:110px" maxlength="1000" placeholder="พิมพ์ความคิดเห็นของคุณ…"></textarea>
                    <label for="cmtText">พิมพ์ความคิดเห็นของคุณ…</label>
                </div>
                <div class="d-flex justify-content-between align-items-center">
                    <small class="text-muted">* จำกัด 1,000 ตัวอักษร · สามารถตอบกลับคอมเมนต์ของคนอื่นได้จากปุ่ม “ตอบกลับ” ใต้คอมเมนต์</small>
                    <button id="cmtSendBtn" type="button" class="btn btn-primary">ส่งความคิดเห็น</button>
                </div>
            </form>
        }
        else
        {
            <div class="alert alert-warning mb-3" role="alert">
                ต้องเข้าสู่ระบบก่อนจึงจะคอมเมนต์หรือ “ตอบกลับ” ได้
                <a class="alert-link" href="/Identity/Account/Login?returnUrl=@Url.Page("/Detail", new { id = b.Id })">เข้าสู่ระบบ</a>
            </div>
        }

        <!-- รายการคอมเมนต์ (JS จะเรนเดอร์ให้ พร้อมปุ่ม 'ตอบกลับ' ใต้แต่ละคอมเมนต์) -->
        <div id="cmtList" class="d-flex flex-column gap-3"></div>
        <div id="cmtEmpty" class="text-muted">ยังไม่มีความคิดเห็น — มาเป็นคนแรกกันเลย!</div>

        <!-- เทมเพลตฟอร์มตอบกลับ (JS จะ clone/แทรกใต้คอมเมนต์เมื่อกดปุ่ม "ตอบกลับ") -->
        <template id="replyFormTpl">
            <div class="reply-form mt-2">
                <textarea class="form-control reply-text" rows="2" maxlength="1000" placeholder="พิมพ์คำตอบของคุณ…"></textarea>
                <div class="d-flex justify-content-end gap-2 mt-2">
                    <button type="button" class="btn btn-light btn-sm reply-cancel">ยกเลิก</button>
                    <button type="button" class="btn btn-primary btn-sm reply-send">ส่งคำตอบ</button>
                </div>
            </div>
        </template>
        <noscript><div class="alert alert-info mt-3">ต้องเปิดใช้ JavaScript เพื่อแสดงและตอบกลับคอมเมนต์</div></noscript>
    </section>

    @* ===== FAB: ปุ่มแก้ไข/ลบ (เฉพาะ Admin) ===== *@
    @if ((User?.IsInRole("Admin") ?? false) && Model?.LocalBeer != null)
    {
        <div class="fab-group" aria-label="fab-actions">
            <a id="fabEdit"
               class="fab fab-edit"
               asp-page="/Admin/editdetail"
               asp-route-id="@Model.LocalBeer.Id"
               title="แก้ไขรายการนี้ (Admin)"
               aria-label="แก้ไขรายการนี้">
                ✏️ <span class="label">แก้ไข</span>
            </a>

            <form id="deleteBeerForm"
                  method="post"
                  asp-page-handler="Delete"
                  asp-route-id="@Model.LocalBeer.Id"
                  class="fab-form"
                  onsubmit="return confirm('ยืนยันลบรายการนี้หรือไม่? การลบจะไม่สามารถย้อนกลับได้');">
                @Html.AntiForgeryToken()
                <button type="submit"
                        id="fabDelete"
                        class="fab fab-delete"
                        title="ลบรายการนี้ (Admin)"
                        aria-label="ลบรายการนี้">
                    🗑️ <span class="label">ลบ</span>
                </button>
            </form>
        </div>
    }


    @section Scripts {
    <script>
        function confirmDelete() {
            return window.confirm('ยืนยันลบรายการนี้หรือไม่? การลบจะไม่สามารถย้อนกลับได้');
        }
    </script>
    }

    <!-- JSON-LD (Structured Data) -->
    <script type="application/ld+json">
        {
          "@@context": "https://schema.org/",
          "@@type": "Product",
          "name": "@(b.Name?.Replace("\"", "\\\""))",
          "image": "@imageSrc",
          "description": "@(b.Description?.Replace("\"", "\\\""))",
          "brand": { "@@type": "Brand", "name": "@(b.Creator ?? "Unknown")" },
          "offers": {
            "@@type": "Offer",
            "priceCurrency": "THB",
            "price": "@priceSafe"
          },
          "aggregateRating": {
            "@@type": "AggregateRating",
            "ratingValue": "@ratingSafe",
            "reviewCount": "@countSafe"
          }
        }
    </script>
}

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<!-- โหลด JS หลักแบบกันแคช -->
<script src="~/js/detail.js" asp-append-version="true"></script>

<script>
    /* ทำ FAB ให้ "ลากได้" แบบเบา ๆ */
    (function () {
      const fab = document.getElementById('fabEdit');
      if (!fab) return;

      let dragging = false, sx = 0, sy = 0, ox = 0, oy = 0;

      const setPos = (x, y) => {
        fab.style.right = 'auto';
        fab.style.bottom = 'auto';
        const w = fab.offsetWidth, h = fab.offsetHeight;
        const maxX = Math.max(0, window.innerWidth - w - 6);
        const maxY = Math.max(0, window.innerHeight - h - 6);
        x = Math.min(Math.max(6, x), maxX);
        y = Math.min(Math.max(6, y), maxY);
        fab.style.left = x + 'px';
        fab.style.top  = y + 'px';
      };

      const down = (e) => {
        dragging = true;
        fab.classList.add('dragging');
        const p = e.touches ? e.touches[0] : e;
        const r = fab.getBoundingClientRect();
        sx = p.clientX; sy = p.clientY; ox = r.left; oy = r.top;

        document.addEventListener('mousemove', move);
        document.addEventListener('mouseup', up);
        document.addEventListener('touchmove', move, { passive: false });
        document.addEventListener('touchend', up);
      };

      const move = (e) => {
        if (!dragging) return;
        if (e.cancelable) e.preventDefault();
        const p = e.touches ? e.touches[0] : e;
        setPos(ox + (p.clientX - sx), oy + (p.clientY - sy));
      };

      const up = () => {
        dragging = false;
        fab.classList.remove('dragging');
        document.removeEventListener('mousemove', move);
        document.removeEventListener('mouseup', up);
        document.removeEventListener('touchmove', move);
        document.removeEventListener('touchend', up);
      };

      fab.addEventListener('mousedown', down);
      fab.addEventListener('touchstart', down, { passive: false });
    })();
</script>
