@page "{handler?}"
@model FinalProject.Pages.ProfileModel
@{
    ViewData["Title"] = "โปรไฟล์ของฉัน";

    string Initials(string name)
    {
        if (string.IsNullOrWhiteSpace(name)) return "?";
        var parts = name.Trim().Split(' ', StringSplitOptions.RemoveEmptyEntries);
        if (parts.Length == 1) return parts[0].Substring(0, 1).ToUpperInvariant();
        return (parts[0][0].ToString() + parts[^1][0]).ToUpperInvariant();
    }

    var initials = Initials(Model.DisplayName ?? Model.Email ?? "User");
    bool hasAvatar = !string.IsNullOrWhiteSpace(Model.AvatarUrl);
}

<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>@ViewData["Title"]</title>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="@Url.Content("~/css/profile.css")" asp-append-version="true" />
</head>
<body>
    <div class="profile-page container">

        <!-- Header -->
        <header class="profile-header">
            <div class="d-flex w-100 align-items-center gap-3 gap-md-4">

                <!-- Avatar -->
                <div class="avatar-wrap" id="changeAvatarBtn" role="img" aria-label="โปรไฟล์ @Model.DisplayName">
                    @if (hasAvatar)
                    {
                        <img id="avatarPreview" src="@Model.AvatarUrl" alt="@Model.DisplayName" class="avatar-img" />
                    }
                    else
                    {
                        <div id="avatarFallback" class="avatar-fallback" data-initials="@initials">
                            <span>@initials</span>
                        </div>
                    }
                    <input type="file" id="avatarUpload" accept="image/*" hidden />
                </div>
                <!-- Identity + stats + actions -->
                <div class="flex-grow-1 min-w-0">
                    <div class="d-flex flex-wrap align-items-center gap-2">
                        <h1 class="display-name mb-0 text-truncate">@Model.DisplayName</h1>
                        <span class="chip-you">คุณ</span>
                    </div>

                    <div class="muted small mt-1 text-truncate">
                        @Model.Email
                        @if (Model.BirthYear is not null)
                        {
                            <span class="ms-2">• 🎂 @Model.BirthYear</span>
                        }
                        <span class="ms-2">• เข้าร่วม @Model.JoinDate.ToString("dd MMM yyyy")</span>
                    </div>

                    <div class="header-row mt-3">
                        <div class="quick-stats">
                            <div class="stat">
                                <div class="val">@Model.Stats?.Reviews</div>
                                <div class="lbl">รีวิว</div>
                            </div>
                            <div class="stat">
                                <div class="val">@Model.Stats?.Favorites</div>
                                <div class="lbl">ถูกใจ</div>
                            </div>
                            <div class="stat">
                                <div class="val">@Model.Stats?.Comments</div>
                                <div class="lbl">คอมเมนต์</div>
                            </div>
                        </div>

                        <div class="actions">
                            <a asp-page="/Edit" class="btn btn-brand btn-sm">
                                แก้ไขโปรไฟล์
                            </a>

                            <button id="shareProfileBtn" class="btn btn-soft btn-sm">แชร์โปรไฟล์</button>  
                        </div>
                    </div>

                    
                    <div class="progress mt-2 d-none" id="uploadProgressWrap" aria-hidden="true" style="max-width:360px;">
                        <div class="progress-bar" id="uploadProgress" style="width:0%"></div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Tabs -->
        <nav class="tabs" role="tablist" aria-label="สลับหมวดโปรไฟล์">
            <button class="tab-btn active" data-tab="favorites" role="tab" aria-selected="true">รายการถูกใจ</button>
            <button class="tab-btn" data-tab="activity" role="tab" aria-selected="false">กิจกรรม</button>
            
            <div class="tab-underline" aria-hidden="true"></div>
        </nav>

        <!-- Panels -->
        <main class="tab-panels">
            <!-- Favorites -->
            <section id="tab-favorites" class="tab-panel active" role="tabpanel">
                <div id="favGrid" class="fav-grid"></div>
                <div id="favEmpty" class="muted text-center py-4 d-none">ยังไม่มีรายการถูกใจ</div>

                <!-- skeletons -->
                <div id="favSkeleton" class="fav-grid">
                    @for (var i = 0; i < 6; i++)
                    {
                        <div class="card card-skeleton">
                            <div class="sk-img"></div>
                            <div class="sk-line w-60"></div>
                            <div class="sk-line w-40"></div>
                        </div>
                    }
                </div>
            </section>

            <!-- Activity -->
            <section id="tab-activity" class="tab-panel" role="tabpanel" aria-labelledby="กิจกรรม">
                <div class="d-flex align-items-center justify-content-between mb-2">
                    <h3 class="section-title mb-0">กิจกรรมล่าสุด</h3>
                    <button id="refreshActivityBtn" class="btn btn-light btn-sm">รีเฟรช</button>
                </div>
                <ul id="activityList" class="timeline">
                    @foreach (var activity in Model.RecentActivities)
                    {
                        <li class="item"><span class="dot"></span><div class="content">@activity</div></li>
                    }
                </ul>
                <div id="activityEmpty" class="muted small d-none">ยังไม่มีกิจกรรม</div>
            </section>

           
            
        </main>
    </div>

    <!-- Endpoints ให้ JS (คงไว้ตามเดิม) -->
    <script>
        window.ProfileEndpoints = {
          upload: '@Url.Page("/Profile", null, new { handler = "UploadAvatar" }, null)',
          remove: '@Url.Page("/Profile", null, new { handler = "RemoveAvatar" }, null)',
          edit: '@Url.Page("/Profile", null, new { handler = "Edit" }, null)',
          activities: '@Url.Page("/Profile", null, new { handler = "Activities" }, null)',
          myFavorites: '/api/me/favorites',
          toggleFavorite: (id) => `/api/beers/${id}/favorite`
        };
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="@Url.Content("~/js/profile.js")" asp-append-version="true"></script>
</body>
</html>
